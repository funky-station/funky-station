// SPDX-FileCopyrightText: 2025 taydeo <td12233a@gmail.com>
//
// SPDX-License-Identifier: MIT

using Content.Client.GameTicking.Managers;
using Content.Shared.Store;
using Robust.Client.AutoGenerated;
using Robust.Client.Graphics;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;
using Robust.Shared.Timing;
using Content.Client.MalfAI.Theme;

namespace Content.Client.Store.Ui;

[GenerateTypedNameReferences]
public sealed partial class MalfStoreListingControl : Control
{
    [Dependency] private readonly IPrototypeManager _prototype = default!;
    [Dependency] private readonly IEntityManager _entity = default!;
    [Dependency] private readonly IGameTiming _timing = default!;
    private readonly ClientGameTicker _ticker;

    private readonly ListingData _data;
    private readonly bool _hasBalance;
    private readonly string _price;

    public MalfStoreListingControl(
        ListingData data,
        string price,
        bool hasBalance,
        Texture? texture = null,
        Font? malfFont = null,
        Color? malfAccent = null)
    {
        IoCManager.InjectDependencies(this);
        RobustXamlLoader.Load(this);

        _ticker = _entity.System<ClientGameTicker>();

        _data = data;
        _hasBalance = hasBalance;
        _price = price;

        // Populate text
        StoreItemName.Text = ListingLocalisationHelpers.GetLocalisedNameOrEntityName(_data, _prototype);
        StoreItemDescription.SetMessage(ListingLocalisationHelpers.GetLocalisedDescriptionOrEntityDescription(_data, _prototype));

        // Apply Malf theme locally (no global changes)
        var accent = malfAccent ?? MalfUiTheme.Accent;

        // Apply malffont to all descendant Labels and RichTextLabels via local stylesheet.
        if (malfFont != null)
        {
            Stylesheet = new Stylesheet(new[]
            {
                new StyleRule(new SelectorElement(typeof(RichTextLabel), null, null, null),
                    new[] { new StyleProperty("font", malfFont) }),
                new StyleRule(new SelectorElement(typeof(Label), null, null, null),
                    new[] { new StyleProperty("font", malfFont) })
            });

            // Redundant but explicit for the main name label and button label:
            StoreItemName.FontOverride = malfFont;
            if (StoreItemBuyButton.Label != null)
                StoreItemBuyButton.Label.FontOverride = malfFont;
        }

        // Accent color
        StoreItemName.Modulate = accent;
        StoreItemDescription.Modulate = accent;

        // Button label accent
        if (StoreItemBuyButton.Label != null)
            StoreItemBuyButton.Label.Modulate = accent;

        // Style button unless explicitly sale-red
        if (!StoreItemBuyButton.HasStyleClass("ButtonColorRed"))
        {
            var buyStyle = MalfUiTheme.CreateButtonStyle(accent);
            StoreItemBuyButton.StyleBoxOverride = buyStyle;
        }

        UpdateBuyButtonText();
        StoreItemBuyButton.Disabled = !CanBuy();

        StoreItemTexture.Texture = texture;
    }

    private bool CanBuy()
    {
        if (!_hasBalance)
            return false;

        var stationTime = _timing.CurTime.Subtract(_ticker.RoundStartTimeSpan);
        if (_data.RestockTime > stationTime)
            return false;

        return true;
    }

    private void UpdateBuyButtonText()
    {
        var stationTime = _timing.CurTime.Subtract(_ticker.RoundStartTimeSpan);
        if (_data.RestockTime > stationTime)
        {
            var timeLeftToBuy = _data.RestockTime - stationTime;
            StoreItemBuyButton.Text = timeLeftToBuy.Duration().ToString(@"mm\:ss");
        }
        else
        {
            StoreItemBuyButton.Text = _price;
        }
    }

    private void UpdateName()
    {
        var name = ListingLocalisationHelpers.GetLocalisedNameOrEntityName(_data, _prototype);

        var stationTime = _timing.CurTime.Subtract(_ticker.RoundStartTimeSpan);
        if (_data.RestockTime > stationTime)
        {
            name += Loc.GetString("store-ui-button-out-of-stock");
        }

        StoreItemName.Text = name;
    }

    protected override void FrameUpdate(FrameEventArgs args)
    {
        base.FrameUpdate(args);

        UpdateBuyButtonText();
        UpdateName();
        StoreItemBuyButton.Disabled = !CanBuy();
    }
}
