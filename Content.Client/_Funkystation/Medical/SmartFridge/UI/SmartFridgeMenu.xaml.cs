using System.Numerics;
using Content.Client.UserInterface.Controls;
using Content.Shared._Funkystation.Medical.SmartFridge;
using Content.Shared.IdentityManagement;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;
using FancyWindow = Content.Client.UserInterface.Controls.FancyWindow;

namespace Content.Client._Funkystation.Medical.SmartFridge.UI;


[GenerateTypedNameReferences]
public sealed partial class SmartFridgeMenu : FancyWindow
{
    [Dependency] private readonly IPrototypeManager _prototypeManager = default!;
    [Dependency] private readonly IEntityManager _entityManager = default!;

    private readonly Dictionary<EntProtoId, EntityUid> _dummies = [];

    //public event Action<GUIBoundKeyEventArgs, ListData>? OnItemSelected;
    public event Action<BaseButton.ButtonEventArgs, SmartFridgeItem.DispenseButton>? OnDispenseButtonPressed;

    /// <summary>
    /// create and initialize the ui, client side
    /// </summary>
    public SmartFridgeMenu()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        VendingContents.SearchBar = SearchBar;
        VendingContents.DataFilterCondition += DataFilterCondition;
        VendingContents.GenerateItem += GenerateButton;
        //VendingContents.ItemKeyBindDown += (args, data) => OnItemSelected?.Invoke(args, data);
    }

    private static bool DataFilterCondition(string filter, ListData data)
    {
        if (data is not FridgeItemsListData { ItemName: var text })
            return false;

        return string.IsNullOrEmpty(filter) || text.Contains(filter, StringComparison.CurrentCultureIgnoreCase);
    }

        private void GenerateButton(ListData data, ListContainerButton button)
    {
        if (data is not FridgeItemsListData { ItemProtoID: var protoId, ItemIdentity: var identity, ItemName: var text, ItemQuantity: var quantity })
            return;

        button.AddChild(new SmartFridgeItem(protoId, text, quantity, true));

        button.ToolTip = $"{identity} [{quantity}]" ;
        // identity is used over name so it says what it is (eg bottle, pill) over what it is labeled
    }

    /// <summary>
    /// populates FridgeItemsListData based on current inventory
    /// </summary>
    public void Populate(List<SmartFridgeInventoryItem> inventory)
    {
        // out of stock labels
        if (inventory.Count == 0 && VendingContents.Visible)
        {
            SearchBar.Visible = false;
            VendingContents.Visible = false;

            var outOfStockLabel = new Label
            {
                Text = Loc.GetString("smart-fridge-oos"),
                Margin = new Thickness(4, 20),
                HorizontalExpand = true,
                VerticalAlignment = VAlignment.Top,
                HorizontalAlignment = HAlignment.Center,
            };

            ContainerContents.AddChild(outOfStockLabel);

            return;
        }

        var listData = new List<FridgeItemsListData>();

        for (var i = 0; i < inventory.Count; i++)
        {
            var entry = inventory[i];
            if (!_prototypeManager.TryIndex(entry.Id, out var prototype))
                continue;

            if (!_dummies.TryGetValue(entry.Id, out var dummy))
            {
                dummy = _entityManager.Spawn(entry.Id);
                _dummies.Add(entry.Id, dummy);
            }

            var itemIdentity = Identity.Name(dummy, _entityManager);
            var itemName = entry.ItemName;
            var quantity = $"{entry.Quantity}";

            listData.Add(new FridgeItemsListData(prototype.ID, itemIdentity, itemName, quantity, i));
        }

        VendingContents.PopulateList(listData);
    }
}

public record FridgeItemsListData(EntProtoId ItemProtoID, string ItemIdentity, string ItemName, string ItemQuantity, int ItemIndex) : ListData;
