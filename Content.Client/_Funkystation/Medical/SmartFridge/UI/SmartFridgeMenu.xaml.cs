using System.Numerics;
using Content.Client.UserInterface.Controls;
using Content.Shared._Funkystation.Medical.SmartFridge;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;
using FancyWindow = Content.Client.UserInterface.Controls.FancyWindow;

namespace Content.Client._Funkystation.Medical.SmartFridge.UI;


[GenerateTypedNameReferences]
public sealed partial class SmartFridgeMenu : FancyWindow
{
    [Dependency] private readonly IPrototypeManager _prototypeManager = default!;
    [Dependency] private readonly IEntityManager _entityManager = default!;

    private readonly Dictionary<EntProtoId, EntityUid> _dummies = [];

    public event Action<GUIBoundKeyEventArgs, ListData>? OnItemSelected;

    /// <summary>
    /// create and initialize the ui, client side
    /// </summary>
    public SmartFridgeMenu()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        VendingContents.SearchBar = SearchBar;
        VendingContents.DataFilterCondition += DataFilterCondition;
        VendingContents.GenerateItem += GenerateButton;
        VendingContents.ItemKeyBindDown += (args, data) => OnItemSelected?.Invoke(args, data);

        // set tab names
        Tabs.SetTabTitle(0, Loc.GetString("smart-fridge-all-tab"));
        // DO NOT SET THE TAB NAMES TO NUMBERS IN THE XAML FILE IT WILL FCUKING BREAK EVERYTHING!!!!!!!!
    }

    private static bool DataFilterCondition(string filter, ListData data)
    {
        if (data is not VendorItemsListData { ItemText: var text })
            return false;

        return string.IsNullOrEmpty(filter) || text.Contains(filter, StringComparison.CurrentCultureIgnoreCase);
    }

        private void GenerateButton(ListData data, ListContainerButton button)
    {
        if (data is not FridgeItemsListData { ItemProtoID: var protoId, ItemName: var text, ItemQuantity: var quantity })
            return;

        button.AddChild(new SmartFridgeItem(protoId, text, quantity, true));

        button.ToolTip = text;
    }

    /// <summary>
    /// populates FridgeItemsListData based on current inventory
    /// </summary>
    public void Populate(List<SmartFridgeInventoryItem> inventory)
    {
        // out of stock labels
        if (inventory.Count == 0 && VendingContents.Visible)
        {
            SearchBar.Visible = false;
            VendingContents.Visible = false;

            var outOfStockLabel = new Label
            {
                Text = Loc.GetString("vending-machine-component-try-eject-out-of-stock"),
                Margin = new Thickness(4, 20),
                HorizontalExpand = true,
                VerticalAlignment = VAlignment.Top,
                HorizontalAlignment = HAlignment.Center,
            };

            ContainerContents.AddChild(outOfStockLabel);

            SetSizeAfterUpdate(outOfStockLabel.Text.Length, 0);

            return;
        }

        // sets up longest entry
        var longestEntry = string.Empty;
        var listData = new List<FridgeItemsListData>();

        for (var i = 0; i < inventory.Count; i++)
        {
            var entry = inventory[i];
            if (!_prototypeManager.TryIndex(entry.Id, out var prototype))
                continue;

            if (!_dummies.TryGetValue(entry.Id, out var dummy))
            {
                dummy = _entityManager.Spawn(entry.Id);
                _dummies.Add(entry.Id, dummy);
            }

            var itemName = entry.ItemName;
            var quantity = $"{entry.Quantity}";

            if (itemName.Length > longestEntry.Length)
                longestEntry = itemName;

            listData.Add(new FridgeItemsListData(prototype.ID, itemName, quantity, i));
        }

        VendingContents.PopulateList(listData);
        SetSizeAfterUpdate(longestEntry.Length, inventory.Count);
    }

    private void SetSizeAfterUpdate(int longestEntryLength, int contentCount)
    {
        SetSize = new Vector2(Math.Clamp((longestEntryLength + 2) * 12, 250, 400),
            Math.Clamp(contentCount * 50, 150, 350));
    }

}

public record FridgeItemsListData(EntProtoId ItemProtoID, string ItemName, string ItemQuantity, int ItemIndex) : ListData;
