// SPDX-FileCopyrightText: 2025 Tyranex <bobthezombie4@gmail.com>
//
// SPDX-License-Identifier: MIT

using System;
using Content.Client.MalfAI.Theme;
using Robust.Client.AutoGenerated;
using Robust.Client.Graphics;
using Robust.Client.ResourceManagement;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;

namespace Content.Client.MalfAI.VoiceModulator;

[GenerateTypedNameReferences]
public sealed partial class MalfVoiceModulatorWindow : DefaultWindow
{
    [Dependency] private readonly IResourceCache _resCache = default!;

    public event Action<string>? OnConfirm;

    public MalfVoiceModulatorWindow(Font? malfFont)
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        // Apply Malf theme: backdrop without static, button style without static, fonts & accent tint.
        RootBackdrop.PanelOverride = MalfUiTheme.CreateBackdropStyle();

        // Add scrolling error backdrop behind all UI elements - insert at beginning so it appears behind
        var errorBackdrop = MalfEffectOverlay.CreateErrorBackdrop();
        RootBackdrop.AddChild(errorBackdrop);
        errorBackdrop.SetPositionInParent(0); // Move to first position (behind all other elements)

        // Add CRT static overlay using the unified effect system - this stays on top
        var staticOverlay = MalfEffectOverlay.CreateStaticOverlay();
        RootBackdrop.AddChild(staticOverlay);
        var buttonStyle = MalfUiTheme.CreateButtonStyle(MalfUiTheme.Accent);

        // Localized text.
        Title = Loc.GetString("malf-voice-window-title");
        HeaderLabel.Text = Loc.GetString("malf-voice-header-label");
        NameEdit.PlaceHolder = Loc.GetString("malf-voice-name-placeholder");
        ConfirmButton.Text = Loc.GetString("malf-voice-confirm-button");

        // Apply Malf stylesheet
        RootBackdrop.Stylesheet = MalfUiTheme.GetCachedStylesheet(_resCache, 12);

        ConfirmButton.StyleBoxOverride = buttonStyle;

        // Apply the theme border to the text input field WITHOUT static (static comes from backdrop overlay)
        NameEdit.StyleBoxOverride = MalfUiTheme.CreateButtonStyle(MalfUiTheme.Accent);

        ConfirmButton.OnPressed += _ =>
        {
            var name = NameEdit.Text?.Trim() ?? string.Empty;
            OnConfirm?.Invoke(name);
        };
    }
}
