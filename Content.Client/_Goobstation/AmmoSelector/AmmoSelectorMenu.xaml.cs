// SPDX-FileCopyrightText: 2024 Aviu00 <93730715+Aviu00@users.noreply.github.com>
// SPDX-FileCopyrightText: 2025 Aiden <28298836+Aidenkrz@users.noreply.github.com>
// SPDX-FileCopyrightText: 2025 Misandry <mary@thughunt.ing>
// SPDX-FileCopyrightText: 2025 SX_7 <sn1.test.preria.2002@gmail.com>
// SPDX-FileCopyrightText: 2025 gus <august.eymann@gmail.com>
//
// SPDX-License-Identifier: AGPL-3.0-or-later

using System.Numerics;
using Content.Client.UserInterface.Controls;
using Content.Shared._Goobstation.Weapons.AmmoSelector;
using Robust.Client.AutoGenerated;
using Robust.Client.GameObjects;
using Robust.Client.Player;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;

namespace Content.Client._Goobstation.AmmoSelector;

[GenerateTypedNameReferences]
public sealed partial class AmmoSelectorMenu : RadialMenu
{
    [Dependency] private readonly EntityManager _entManager = default!;
    [Dependency] private readonly IPrototypeManager _protoManager = default!;
    [Dependency] private readonly IPlayerManager _playerManager = default!;

    private SpriteSystem _sprites;

    public event Action<ProtoId<SelectableAmmoPrototype>>? SendAmmoSelectorSystemMessageAction;

    private EntityUid _item;

    public AmmoSelectorMenu()
    {
        IoCManager.InjectDependencies(this);
        RobustXamlLoader.Load(this);
        _sprites = _entManager.System<SpriteSystem>();
    }

    public void SetEntity(EntityUid uid)
    {
        _item = uid;
        Refresh();
    }

    public void Refresh()
    {
        // Find the SimpleRadialMenu in the XAML. Ensure your XAML uses a SimpleRadialMenu named "Main".
        var main = FindControl<SimpleRadialMenu>("Main");

        // Build models for each ammo prototype and hand them to the SimpleRadialMenu
        var models = new List<RadialMenuOptionBase>();

        if (!_entManager.TryGetComponent(_item, out AmmoSelectorComponent? ammoSelector))
            return;

        foreach (var ammo in ammoSelector.Prototypes)
        {
            if (!_protoManager.TryIndex(ammo, out SelectableAmmoPrototype? prototype))
                continue;

            // Create an action option - when pressed, send the prototype id back and the SimpleRadialMenu will close.
            var protoId = prototype.ID;
            var action = new RadialMenuActionOption<ProtoId<SelectableAmmoPrototype>>(
                onPressed: (ProtoId<SelectableAmmoPrototype> p) =>
                {
                    SendAmmoSelectorSystemMessageAction?.Invoke(p);
                },
                data: protoId
            )
            {
                ToolTip = Loc.GetString(prototype.Desc),
                IconSpecifier = RadialMenuIconSpecifier.With(prototype.Icon)
            };

            models.Add(action);
        }

        // Optionally you can customize settings. Use defaults for now.
        main.SetButtons(models);

        // Open where the mouse is (similar UX to previous radial menus that open at cursor)
        main.OpenOverMouseScreenPosition();
    }
}
